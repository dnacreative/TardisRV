<!DOCTYPE html>
<html>
<head>
    <!--librerie-->
    <script src="http://127.0.0.1:8080/js/three.js"></script>

    <!--moduli-->
    <script src="http://127.0.0.1:8080/js/initPointLock.js"></script>    
    <script src="http://127.0.0.1:8080/js/MovementControl.js"></script>
    <script src="http://127.0.0.1:8080/js/blenderImporter.js"></script>
    <script src="http://127.0.0.1:8080/js/Animation.js"></script>
    <script src="http://127.0.0.1:8080/js/Clickable.js"></script>

    <style>
            html, body {
                width: 100%;
                height: 100%;
            }

            body {
                background-color: #ffffff;
                margin: 0;
                overflow: hidden;
                font-family: arial;
            }

            #blocker {

                position: absolute;

                width: 100%;
                height: 100%;

                background-color: rgba(0,0,0,0.5);

            }

            #instructions {

                width: 100%;
                height: 100%;

                display: -webkit-box;
                display: -moz-box;
                display: box;

                -webkit-box-orient: horizontal;
                -moz-box-orient: horizontal;
                box-orient: horizontal;

                -webkit-box-pack: center;
                -moz-box-pack: center;
                box-pack: center;

                -webkit-box-align: center;
                -moz-box-align: center;
                box-align: center;

                color: #ffffff;
                text-align: center;

                cursor: pointer;

            }
    </style>
</head>
<body>
    <div id="blocker">
        <div id="instructions">
            <span style="font-size:40px">Click to play</span>
            <br/>
            (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
         </div>
    </div>
      
    <script>

        var camera, scene, renderer;
        var geometry, material, mesh;
        var manopola;
        var controls ,time = Date.now();
        var ray;
        var blocker = document.getElementById( 'blocker' );
        var instructions = document.getElementById( 'instructions' );
        var cylinder1, cylinder2, cylinder3, cylinder4; 
        //var muoviManopola=false;

        //ar t=0;
        var line
        var collidableMeshList;
        var manapolaAnimation;
        var annie;

        initPointLock(blocker, instructions);

        init();

        animate();


        function init() {



            camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 10000 );
            //camera.applyMatrix( new THREE.Matrix4().makeTranslation(400, 400, 400) );

            scene = new THREE.Scene();

            controls = new THREE.PointerLockControls( camera );

            /** CLICKABLE **/
            var clickable = new Clickable(controls); //instazio la classe clickable passandogli la variabile legata a PointerLockControls
            document.addEventListener( 'mousedown', clickable.onDocumentMouseDown, false ); // aggiungo l'evento mousedown
            /*******/

            scene.add( controls.getObject() );

            ray = new THREE.Raycaster();
                ray.ray.direction.set( 0, -1, 0 );

            
            //floor
            var plane = new THREE.Mesh(
                new THREE.PlaneGeometry(1000, 1000, 100, 100),
                new THREE.MeshLambertMaterial({color: 0xFFFFFF})
                );
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = 0;
            plane.receiveShadow = true;
            scene.add(plane);


            //cilindri energetici
            cylinder1 = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xCD0000})
                );
            cylinder1.receiveShadow = true;
            cylinder1.overdraw = true;
            cylinder1.position.set(-15,185,-15);
            scene.add(cylinder1);
            
            cylinder2 = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xCD0000} )
                );
            cylinder2.receiveShadow = true;
            cylinder2.overdraw = true;
            cylinder2.position.set(15,185,-15);
            scene.add(cylinder2);

            cylinder3 = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xCD0000})
                );
            cylinder3.receiveShadow = true;
            cylinder3.overdraw = true;
            cylinder3.position.set(15,185,15);
            scene.add(cylinder3);
            
            cylinder4 = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xCD0000})
                );
            cylinder4.receiveShadow = true;
            cylinder4.overdraw = true;
            cylinder4.position.set(-15,185,15);
            scene.add(cylinder4);
                        

            var importer = new blenderImporter(scene);
            
            importer.import('tardis.js', 50, [0,0,0], [0,0,0], function(geometry, object){
                console.log('callBack');
                controls.addMesh(object);
            });
            

            importer.import('manopola.js', 50, [-68,145,-68], [0, -51.788, 0], function(geometry, object){
                    console.log('callBack');
                    //console.log(mesh);
                    manopola = object;
                    //geometry.applyMatrix( new THREE.Matrix4().makeRotationY(-51.788) );
                    manopola.rotateOnAxis( new THREE.Vector3(1,0,-0.70).normalize(), 0.4 );
                    manapolaAnimation = new Animation(manopola);
                    //manapolaAnimation.startAni();
                    clickable.addCMesh(manopola);
                    
                });

            

            var spotlight = new THREE.SpotLight(0xffffff);
            spotlight.position.set(0,600,0);
            spotlight.shadowCameraVisible = true;
            //spotlight.shadowDarkness = 0.25;
            spotlight.intensity = 3;
            //spotlight.shadowCameraFov = 100;
            // must enable shadow casting ability for the light
            spotlight.castShadow = true;
            scene.add(spotlight);

            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.shadowMapEnabled = true;
            document.body.appendChild( renderer.domElement );

            window.addEventListener( 'resize', onWindowResize, false );

            var primaVolta = true;

            //TEST

            ///////////
            // VIDEO //
            ///////////
            
            // create the video element
            video = document.createElement( 'video' );
            // video.id = 'video';
            //video.type = ' video/mp4; codecs="theora, vorbis" ';
            video.src = "http://127.0.0.1:8080/esperimenti/kideatsdirt.ogv";
            video.load(); // must call after setting/changing source
            video.play();
            
            
            videoImage = document.createElement( 'canvas' );
            videoImage.width = 320;
            videoImage.height = 240;

            videoImageContext = videoImage.getContext( '2d' );
            videoImageContext.fillRect( 0, 0, videoImage.width, videoImage.height );

            videoTexture = new THREE.Texture( videoImage );
            videoTexture.minFilter = THREE.LinearFilter;
            videoTexture.magFilter = THREE.LinearFilter;
            
            var movieMaterial = new THREE.MeshBasicMaterial( { map: videoTexture, overdraw: true, side:THREE.DoubleSide } );
            // the geometry on which the movie will be displayed;
            //      movie image will be scaled to fit these dimensions.
            //var movieGeometry = new THREE.PlaneGeometry( 50, 50, 1, 1 );
            var movieGeometry = new THREE.CircleGeometry( 30, 128 );
            var movieScreen = new THREE.Mesh( movieGeometry, movieMaterial );

            movieScreen.position.set(-100,142,-5);
            movieScreen.rotation.x = -Math.PI / 2;
            movieScreen.rotation.y = -Math.PI / 8;
            movieScreen.rotation.z = -Math.PI / 2;

            scene.add(movieScreen);

            //END TEST

            ///////////////////////
             var material = new THREE.LineBasicMaterial({
                color: 0xff0000,
                linewidth: 2
            });

            var geometry = new THREE.Geometry();
            geometry.vertices.push(new THREE.Vector3(6, 0, 0));
            geometry.vertices.push(new THREE.Vector3(0, 6, 0));


            line = new THREE.Line(geometry, material);
            line.position.set(24,142,-85);
            line.rotation.y = Math.PI /3;

            scene.add(line);

        }



        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );

        }


        function animate() {
            requestAnimationFrame( animate );
                    
            manapolaAnimation.update();
            
           //controls.isOnObject( false );

            ray.ray.origin.copy( controls.getObject().position );
            ray.ray.origin.y -= 10;

            if ( video.readyState === video.HAVE_ENOUGH_DATA ) {
                videoImageContext.drawImage( video, 0, 0 );
                if ( videoTexture ) {
                    videoTexture.needsUpdate = true;
                    console.log('videoUpdate');
                }
            }
            
            controls.update( Date.now() - time );

///
             //line.rotateOnAxis( new THREE.Vector3(0,1,0).normalize(), 0.05 );
            

            renderer.render( scene, camera );

            time = Date.now();
        }
    </script>
</body>
</html>