<!DOCTYPE html>
<html>
<head>
    <!--librerie-->
    <script src="http://127.0.0.1:8080/js/three.js"></script>

    <!--moduli-->
    <script src="http://127.0.0.1:8080/js/initPointLock.js"></script>    
    <script src="http://127.0.0.1:8080/js/MovementControl.js"></script>
    <script src="http://127.0.0.1:8080/js/blenderImporter.js"></script>
    <script src="http://127.0.0.1:8080/js/ManopolaAnimation.js"></script>
    <script src="http://127.0.0.1:8080/js/Clickable.js"></script>
    <script src="http://127.0.0.1:8080/js/video.js"></script>
    <script src="http://127.0.0.1:8080/js/debugAxes.js"></script>

    <link href="http://127.0.0.1:8080/style/tardis.css" rel="stylesheet" type="text/css">
    <style>
            
    </style>
</head>
<body>
    <div id="blocker">
        <div id="instructions">
            <span style="font-size:40px">Click to play</span>
            <br/>
            (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
         </div>
    </div>
      
    <script>

        var camera, scene, renderer;
        var geometry, material, mesh;
        //var manopola1;
        //var manopola2;
        var controls ,time = Date.now();
        var ray;
        var blocker = document.getElementById( 'blocker' );
        var instructions = document.getElementById( 'instructions' );
        var cylinder1, cylinder2, cylinder3, cylinder4; 
        //var muoviManopola=false;

        //ar t=0;

        var collidableMeshList;
        var manopolaAnimation1;
        var manopolaAnimation2;
        var loadV, loadV2;
        var line;

        initPointLock(blocker, instructions);

        init();

        animate();


        function init() {



            camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 10000 );
            //camera.applyMatrix( new THREE.Matrix4().makeTranslation(400, 400, 400) );

            scene = new THREE.Scene();

            controls = new THREE.PointerLockControls( camera );

            /** CLICKABLE **/
            var clickable = new Clickable(controls); //instazio la classe clickable passandogli la variabile legata a PointerLockControls
            document.addEventListener( 'mousedown', clickable.onDocumentMouseDown, false ); // aggiungo l'evento mousedown
            /*******/

            scene.add( controls.getObject() );

            ray = new THREE.Raycaster();
                ray.ray.direction.set( 0, -1, 0 );

            
            //floor
            var plane = new THREE.Mesh(
                new THREE.PlaneGeometry(1000, 1000, 100, 100),
                new THREE.MeshLambertMaterial({color: 0xFFFFFF})
                );
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = 0;
            plane.receiveShadow = true;
            scene.add(plane);


            //cilindri energetici
            cylinder1 = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xCD0000})
                );
            cylinder1.receiveShadow = true;
            cylinder1.overdraw = true;
            cylinder1.position.set(-15,185,-15);
            scene.add(cylinder1);
            
            cylinder2 = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xCD0000} )
                );
            cylinder2.receiveShadow = true;
            cylinder2.overdraw = true;
            cylinder2.position.set(15,185,-15);
            scene.add(cylinder2);

            cylinder3 = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xCD0000})
                );
            cylinder3.receiveShadow = true;
            cylinder3.overdraw = true;
            cylinder3.position.set(15,185,15);
            scene.add(cylinder3);
            
            cylinder4 = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xCD0000})
                );
            cylinder4.receiveShadow = true;
            cylinder4.overdraw = true;
            cylinder4.position.set(-15,185,15);
            scene.add(cylinder4);
                        

            var importer = new blenderImporter(scene);
            
            importer.import('tardis.js', 50, [0,0,0], [0,0,0], function(geometry, object){
                console.log('callBack');
                controls.addMesh(object);
            });
            

            importer.import('manopola.js', 50, [-27,145,-92], [0, -51.788, 0], function(geometry, object){
                    console.log('callBack');
                    object.rotateOnAxis( new THREE.Vector3(1,0,-0.45).normalize(), 0.4 );
                    manopolaAnimation2 = new ManopolaAnimation(object, new THREE.Vector3(1,0,-0.45), function(){
                        //console.log('accesa');
                    }, function(){
                        //console.log('spenta');
                    });
                    clickable.addCMesh(new Array(object, manopolaAnimation2));
                    
                });

            importer.import('manopola.js', 50, [-68,145,-68], [0, -51.788, 0], function(geometry, object){
                    console.log('callBack');
                    object.rotateOnAxis( new THREE.Vector3(1,0,-0.70).normalize(), 0.4 );
                    manopolaAnimation1 = new ManopolaAnimation(object, new THREE.Vector3(1,0,-0.70), function (){
                        var a = Math.floor((Math.random()*100)+1)%8;
                        if(a === 0){
                            cylinder1.material.emissive.setHex( 0xff0000 );
                        }
                        if(a == 1){
                            cylinder1.material.emissive.setHex( 0x8B0000 );
                        }
                        if(a == 2){
                            cylinder2.material.emissive.setHex( 0xff0000 );
                        }
                        if(a == 3){
                            cylinder2.material.emissive.setHex( 0x8B0000 );
                        }
                        if(a == 4){
                            cylinder3.material.emissive.setHex( 0xff0000 );
                        }
                        if(a == 5){
                            cylinder3.material.emissive.setHex( 0x8B0000 );
                        }
                        if(a == 6){
                            cylinder4.material.emissive.setHex( 0xff0000 );
                        }
                        if(a == 7){
                            cylinder4.material.emissive.setHex( 0x8B0000 );
                        }
                    }, function(){
                        cylinder1.material.emissive.setHex( 0x8B0000 );
                        cylinder2.material.emissive.setHex( 0x8B0000 );
                        cylinder3.material.emissive.setHex( 0x8B0000 );
                        cylinder4.material.emissive.setHex( 0x8B0000 );
                        });
                    //manapolaAnimation.startAni();
                    clickable.addCMesh(new Array(object, manopolaAnimation1));
                });

            var spotlight = new THREE.SpotLight(0xffffff);
            spotlight.position.set(0,600,0);
            spotlight.shadowCameraVisible = true;
            //spotlight.shadowDarkness = 0.25;
            spotlight.intensity = 3;
            //spotlight.shadowCameraFov = 100;
            // must enable shadow casting ability for the light
            spotlight.castShadow = true;
            scene.add(spotlight);

            loadV = new video(scene);
            loadV.loadVideo("http://127.0.0.1:8080/esperimenti/kideatsdirt.ogv", 30, function(movieScreen){

                movieScreen.position.set(-100, 142, -5);
                movieScreen.rotation.x = -Math.PI / 2;
                movieScreen.rotation.y = -Math.PI / 8;
                movieScreen.rotation.z = -Math.PI / 2;
            }, false);

            loadV2 = new video(scene);
            loadV2.loadVideo("http://127.0.0.1:8080/esperimenti/kideatsdirt.ogv", 12, function(movieScreen){

                movieScreen.position.set(-42, 160, 80);
                movieScreen.rotation.x = - Math.PI / 16;
                movieScreen.rotation.y = - Math.PI / 8 - Math.PI / 16;
                movieScreen.rotation.z = - Math.PI / 32;

                //movieScreen.rotateOnAxis(new THREE.Vector3( -1, 0, -0.3 ).normalize(), Math.PI / 16 + Math.PI / 32);

            }, true);

            //DEBUG-Axes
            axes = buildAxes( 1000 );
            scene.add( axes );

            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.shadowMapEnabled = true;
            document.body.appendChild( renderer.domElement );

            window.addEventListener( 'resize', onWindowResize, false );

            var primaVolta = true;

            //////////////////////
            var material = new THREE.LineBasicMaterial({
                color: 0xff0000,
                linewidth: 2
            });

            var geometry = new THREE.Geometry();
            geometry.vertices.push(new THREE.Vector3(6, 0, 0));
            geometry.vertices.push(new THREE.Vector3(0, 6, 0));


            line = new THREE.Line(geometry, material);
            line.position.set(24, 143, -85);
            line.rotation.y = Math.PI / 3;

            scene.add(line);

            var geometry2 = new THREE.Geometry();
            geometry2.vertices.push(new THREE.Vector3(6, 0, 0));
            geometry2.vertices.push(new THREE.Vector3(0, 6, 0));


            line = new THREE.Line(geometry2, material);
            line.position.set(65, 143, -62);
            line.rotation.y = Math.PI / 3;

            scene.add(line);
        }

        

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );

        }


        function animate() {
            requestAnimationFrame( animate );
                    
            manopolaAnimation1.update();
            manopolaAnimation2.update();
            
           //controls.isOnObject( false );

            ray.ray.origin.copy( controls.getObject().position );
            ray.ray.origin.y -= 10;

            /*
            var intersections = ray.intersectObjects( objects );

            if ( intersections.length > 0 ) {

                var distance = intersections[ 0 ].distance;

                if ( distance > 0 && distance < 10 ) {

                    controls.isOnObject( true );

                }

            }
            */

            loadV.update();
            loadV2.update();
            
            controls.update( Date.now() - time );
            

            renderer.render( scene, camera );

            time = Date.now();
        }
    </script>
</body>
</html>