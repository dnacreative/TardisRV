<!DOCTYPE html>
<html>
<head>
    <!--librerie-->
    <script src="http://127.0.0.1:8080/js/three.js"></script>

    <!--moduli-->
    <script src="http://127.0.0.1:8080/js/initPointLock.js"></script>    
    <script src="http://127.0.0.1:8080/js/MovementControl.js"></script>
    <script src="http://127.0.0.1:8080/js/blenderImporter.js"></script>
    <script src="http://127.0.0.1:8080/js/Animation.js"></script>
    <script src="http://127.0.0.1:8080/js/Clickable.js"></script>

    <style>
            html, body {
                width: 100%;
                height: 100%;
            }

            body {
                background-color: #ffffff;
                margin: 0;
                overflow: hidden;
                font-family: arial;
            }

            #blocker {

                position: absolute;

                width: 100%;
                height: 100%;

                background-color: rgba(0,0,0,0.5);

            }

            #instructions {

                width: 100%;
                height: 100%;

                display: -webkit-box;
                display: -moz-box;
                display: box;

                -webkit-box-orient: horizontal;
                -moz-box-orient: horizontal;
                box-orient: horizontal;

                -webkit-box-pack: center;
                -moz-box-pack: center;
                box-pack: center;

                -webkit-box-align: center;
                -moz-box-align: center;
                box-align: center;

                color: #ffffff;
                text-align: center;

                cursor: pointer;

            }
    </style>
</head>
<body>
    <div id="blocker">
        <div id="instructions">
            <span style="font-size:40px">Click to play</span>
            <br/>
            (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
         </div>
    </div>
      
    <script>

        var camera, scene, renderer;
        var geometry, material, mesh;
        var manopola;
        var controls ,time = Date.now();
        var ray;
        var blocker = document.getElementById( 'blocker' );
        var instructions = document.getElementById( 'instructions' );

        //var muoviManopola=false;

        //ar t=0;

        var collidableMeshList;
        var manapolaAnimation;

        initPointLock(blocker, instructions);

        init();

        animate();


        function init() {



            camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 10000 );
            //camera.applyMatrix( new THREE.Matrix4().makeTranslation(400, 400, 400) );

            scene = new THREE.Scene();

            controls = new THREE.PointerLockControls( camera );

            /** CLICKABLE **/
            var clickable = new Clickable(controls); //instazio la classe clickable passandogli la variabile legata a PointerLockControls
            document.addEventListener( 'mousedown', clickable.onDocumentMouseDown, false ); // aggiungo l'evento mousedown
            /*******/

            scene.add( controls.getObject() );

            ray = new THREE.Raycaster();
                ray.ray.direction.set( 0, -1, 0 );

            
            //floor
            var plane = new THREE.Mesh(
                new THREE.PlaneGeometry(1000, 1000, 100, 100),
                new THREE.MeshLambertMaterial({color: 0xFFFFFF})
                );
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = 0;
            plane.receiveShadow = true;
            scene.add(plane);


            //cilindri energetici
            var cylinder = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xFFFFFF})
                );
            cylinder.receiveShadow = true;
            cylinder.overdraw = true;
            cylinder.position.set(-15,185,-15);
            scene.add(cylinder);
            
            var cylinder = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xFFFFFF})
                );
            cylinder.receiveShadow = true;
            cylinder.overdraw = true;
            cylinder.position.set(15,185,-15);
            scene.add(cylinder);
            
            var cylinder = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xFFFFFF})
                );
            cylinder.receiveShadow = true;
            cylinder.overdraw = true;
            cylinder.position.set(15,185,15);
            scene.add(cylinder);
            
            var cylinder = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 60, 100, 100, false),
                new THREE.MeshLambertMaterial({color: 0xFFFFFF})
                );
            cylinder.receiveShadow = true;
            cylinder.overdraw = true;
            cylinder.position.set(-15,185,15);
            scene.add(cylinder);
                        

            var importer = new blenderImporter(scene);

            
            importer.import('tardis.js', 50, [0,0,0], [0,0,0], function(geometry, object){
                console.log('callBack');
                controls.addMesh(mesh);
            });
            

            importer.import('manopola.js', 50, [-68,145,-68], [0, -51.788, 0], function(geometry, object){
                    console.log('callBack');
                    //console.log(mesh);
                    manopola = object;
                    //geometry.applyMatrix( new THREE.Matrix4().makeRotationY(-51.788) );
                    manopola.rotateOnAxis( new THREE.Vector3(1,0,-0.70).normalize(), 0.4 );
                    manapolaAnimation = new Animation(manopola);
                    //manapolaAnimation.startAni();
                    clickable.addCMesh(manopola);
                    
                });

            

            var spotlight = new THREE.SpotLight(0xffffff);
            spotlight.position.set(0,600,0);
            spotlight.shadowCameraVisible = true;
            //spotlight.shadowDarkness = 0.25;
            spotlight.intensity = 3;
            //spotlight.shadowCameraFov = 100;
            // must enable shadow casting ability for the light
            spotlight.castShadow = true;
            scene.add(spotlight);

            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.shadowMapEnabled = true;
            document.body.appendChild( renderer.domElement );

            window.addEventListener( 'resize', onWindowResize, false );

            var primaVolta = true;

            //NON SERVE PIU'
            // window.addEventListener('click', function(e){ 
            //     if (!primaVolta){
            //         manapolaAnimation.startAni();
            //         //alert('asdasd');
            //     }else{
            //         primaVolta = false;
            //     }
            // });
        
        }


        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );

        }


        function animate() {
            requestAnimationFrame( animate );
                    
            manapolaAnimation.update();
            
           //controls.isOnObject( false );

            ray.ray.origin.copy( controls.getObject().position );
            ray.ray.origin.y -= 10;

            /*
            var intersections = ray.intersectObjects( objects );

            if ( intersections.length > 0 ) {

                var distance = intersections[ 0 ].distance;

                if ( distance > 0 && distance < 10 ) {

                    controls.isOnObject( true );

                }

            }
            */
            
            //controls.update( Date.now() - time );
            controls.update(1);

            renderer.render( scene, camera );

            time = Date.now();
        }
    </script>
</body>
</html>